/*
 TableDnD plug-in for JQuery
 https://github.com/isocra/TableDnD/
 Copyright (c) Denis Howlett <denish@isocra.com>
 Licensed like jQuery, see http://docs.jquery.com/License.
 Fork: https://github.com/k-x/TableDnD/
*/
(function(a,j,f,s){var n="ontouchstart"in f.documentElement,o=n?"touchstart":"mousedown",p=n?"touchmove":"mousemove",q=n?"touchend":"mouseup";n&&a.each("touchstart touchmove touchend".split(" "),function(b,c){a.event.fixHooks[c]=a.event.mouseHooks});a(f).ready(function(){function b(b){for(var a={},b=b.match(/([^;:]+)/g)||[];b.length;)a[b.shift()]=b.shift().trim();return a}a("table").each(function(){"dnd"==a(this).data("table")&&a(this).tableDnD({onDragStyle:a(this).data("ondragstyle")&&b(a(this).data("ondragstyle"))||
null,onDropStyle:a(this).data("ondropstyle")&&b(a(this).data("ondropstyle"))||null,onDragClass:a(this).data("ondragclass")==s&&"tDnD_whileDrag"||a(this).data("ondragclass"),onDrop:a(this).data("ondrop")&&new Function("table","row",a(this).data("ondrop")),onDragStart:a(this).data("ondragstart")&&new Function("table","row",a(this).data("ondragstart")),scrollAmount:a(this).data("scrollamount")||5,sensitivity:a(this).data("sensitivity")||10,hierarchyLevel:a(this).data("hierarchylevel")||0,indentArtifact:a(this).data("indentartifact")||
'<div class="indent">&nbsp;</div>',autoWidthAdjust:a(this).data("autowidthadjust")||!0,autoCleanRelations:a(this).data("autocleanrelations")||!0,jsonPretifySeparator:a(this).data("jsonpretifyseparator")||"\t",serializeRegexp:a(this).data("serializeregexp")&&RegExp(a(this).data("serializeregexp"))||/[^\-]*$/,serializeParamName:a(this).data("serializeparamname")||!1,dragHandle:a(this).data("draghandle")||null})})});j.jQuery.tableDnD={currentTable:null,dragObject:null,mouseOffset:null,oldX:0,oldY:0,
build:function(b){this.each(function(){this.tableDnDConfig=a.extend({onDragStyle:null,onDropStyle:null,onDragClass:"tDnD_whileDrag",onDrop:null,onDragStart:null,scrollAmount:5,sensitivity:10,hierarchyLevel:0,indentArtifact:'<div class="indent">&nbsp;</div>',autoWidthAdjust:!0,autoCleanRelations:!0,jsonPretifySeparator:"\t",serializeRegexp:/[^\-]*$/,serializeParamName:!1,dragHandle:null},b||{});a.tableDnD.makeDraggable(this);this.tableDnDConfig.hierarchyLevel&&a.tableDnD.makeIndented(this)});return this},
makeIndented:function(b){var c=b.tableDnDConfig,d=b.rows,e=a(d).first().find("td:first")[0],h=0,r=0,f,i;if(a(b).hasClass("indtd"))return null;i=a(b).addClass("indtd").attr("style");a(b).css({whiteSpace:"nowrap"});for(var g=0;g<d.length;g++)if(r<a(d[g]).find("td:first").text().length)r=a(d[g]).find("td:first").text().length,f=g;a(e).css({width:"auto"});for(g=0;g<c.hierarchyLevel;g++)a(d[f]).find("td:first").prepend(c.indentArtifact);e&&a(e).css({width:e.offsetWidth});i&&a(b).css(i);for(g=0;g<c.hierarchyLevel;g++)a(d[f]).find("td:first").children(":first").remove();
c.hierarchyLevel&&a(d).each(function(){h=a(this).data("level")||0;h<=c.hierarchyLevel&&a(this).data("level",h)||a(this).data("level",0);for(var b=0;b<a(this).data("level");b++)a(this).find("td:first").prepend(c.indentArtifact)});return this},makeDraggable:function(b){var c=b.tableDnDConfig;c.dragHandle&&a(c.dragHandle,b).each(function(){a(this).bind(o,function(d){a.tableDnD.initialiseDrag(a(this).parents("tr")[0],b,this,d,c);return!1})})||a(b.rows).each(function(){a(this).hasClass("nodrag")||a(this).bind(o,
function(d){if("TD"==d.target.tagName)return a.tableDnD.initialiseDrag(this,b,this,d,c),!1}).css("cursor","move")})},currentOrder:function(){return a.map(this.currentTable.rows,function(b){return(a(b).data("level")+b.id).replace(/\s/g,"")}).join("")},initialiseDrag:function(b,c,d,e,h){this.dragObject=b;this.currentTable=c;this.mouseOffset=this.getMouseOffset(d,e);this.originalOrder=this.currentOrder();a(f).bind(p,this.mousemove).bind(q,this.mouseup);h.onDragStart&&h.onDragStart(c,d)},updateTables:function(){this.each(function(){this.tableDnDConfig&&
a.tableDnD.makeDraggable(this)})},mouseCoords:function(b){return b.pageX||b.pageY?{x:b.pageX,y:b.pageY}:{x:b.clientX+f.body.scrollLeft-f.body.clientLeft,y:b.clientY+f.body.scrollTop-f.body.clientTop}},getMouseOffset:function(b,a){var d,e,a=a||j.event;e=this.getPosition(b);d=this.mouseCoords(a);return{x:d.x-e.x,y:d.y-e.y}},getPosition:function(b){var a=0,d=0;if(0==b.offsetHeight)b=b.firstChild;for(;b.offsetParent;)a+=b.offsetLeft,d+=b.offsetTop,b=b.offsetParent;a+=b.offsetLeft;d+=b.offsetTop;return{x:a,
y:d}},autoScroll:function(a){var c=this.currentTable.tableDnDConfig,d=j.pageYOffset,e=j.innerHeight?j.innerHeight:f.documentElement.clientHeight?f.documentElement.clientHeight:f.body.clientHeight;if(f.all)if("undefined"!=typeof f.compatMode&&"BackCompat"!=f.compatMode)d=f.documentElement.scrollTop;else if("undefined"!=typeof f.body)d=f.body.scrollTop;a.y-d<c.scrollAmount&&j.scrollBy(0,-c.scrollAmount)||e-(a.y-d)<c.scrollAmount&&j.scrollBy(0,c.scrollAmount)},moveVerticle:function(a,c){0!=a.vertical&&
c&&this.dragObject!=c&&this.dragObject.parentNode==c.parentNode&&(0>a.vertical&&this.dragObject.parentNode.insertBefore(this.dragObject,c.nextSibling)||0<a.vertical&&this.dragObject.parentNode.insertBefore(this.dragObject,c))},moveHorizontal:function(b,c){var d=this.currentTable.tableDnDConfig,e;if(!d.hierarchyLevel||0==b.horizontal||!c||this.dragObject!=c)return null;e=a(c).data("level");0<b.horizontal&&0<e&&a(c).find("td:first").children(":first").remove()&&a(c).data("level",--e);0>b.horizontal&&
e<d.hierarchyLevel&&a(c).prev().data("level")>=e&&a(c).children(":first").prepend(d.indentArtifact)&&a(c).data("level",++e)},mousemove:function(b){var c=a(a.tableDnD.dragObject),d=a.tableDnD.currentTable.tableDnDConfig,e;b&&b.preventDefault();if(!a.tableDnD.dragObject)return!1;"touchmove"==b.type&&event.preventDefault();d.onDragClass&&c.addClass(d.onDragClass)||c.css(d.onDragStyle);e=a.tableDnD.mouseCoords(b);b=e.x-a.tableDnD.mouseOffset.x;d=e.y-a.tableDnD.mouseOffset.y;a.tableDnD.autoScroll(e);c=
a.tableDnD.findDropTargetRow(c,d);b=a.tableDnD.findDragDirection(b,d);a.tableDnD.moveVerticle(b,c);a.tableDnD.moveHorizontal(b,c);return!1},findDragDirection:function(a,c){var d=this.currentTable.tableDnDConfig.sensitivity,e=this.oldX,h=this.oldY,d={horizontal:a>=e-d&&a<=e+d?0:a>e?-1:1,vertical:c>=h-d&&c<=h+d?0:c>h?-1:1};if(0!=d.horizontal)this.oldX=a;if(0!=d.vertical)this.oldY=c;return d},findDropTargetRow:function(b,c){for(var d=0,e=this.currentTable.rows,h=this.currentTable.tableDnDConfig,f=0,
k=null,i=0;i<e.length;i++){k=e[i];f=this.getPosition(k).y;d=parseInt(k.offsetHeight)/2;if(0==k.offsetHeight)f=this.getPosition(k.firstChild).y,d=parseInt(k.firstChild.offsetHeight)/2;if(c>f-d&&c<f+d)if(k==b||h.onAllowDrop&&!h.onAllowDrop(b,k)||a(k).hasClass("nodrop"))break;else return k}return null},processMouseup:function(){var b=this.currentTable.tableDnDConfig,c=this.dragObject,d=0,e=0;if(!this.currentTable||!c)return null;a(f).unbind(p,this.mousemove).unbind(q,this.mouseup);b.hierarchyLevel&&
b.autoCleanRelations&&a(this.currentTable.rows).first().find("td:first").children().each(function(){(e=a(this).parents("tr:first").data("level"))&&a(this).parents("tr:first").data("level",--e)&&a(this).remove()})&&1<b.hierarchyLevel&&a(this.currentTable.rows).each(function(){e=a(this).data("level");if(1<e)for(d=a(this).prev().data("level");e>d+1;)a(this).find("td:first").children(":first").remove(),a(this).data("level",--e)});b.onDragClass&&a(c).removeClass(b.onDragClass)||a(c).css(b.onDropStyle);
this.dragObject=null;b.onDrop&&this.originalOrder!=this.currentOrder()&&b.onDrop(this.currentTable,c);this.currentTable=null},mouseup:function(b){b&&b.preventDefault();a.tableDnD.processMouseup();return!1},jsonize:function(a){var c=this.currentTable;return a?JSON.stringify(this.tableData(c),null,c.tableDnDConfig.jsonPretifySeparator):JSON.stringify(this.tableData(c))},serialize:function(){return a.param(this.tableData(this.currentTable))},serializeTable:function(a){for(var c="",d=a.tableDnDConfig.serializeParamName||
a.id,e=a.rows,h=0;h<e.length;h++){0<c.length&&(c+="&");var f=e[h].id;f&&a.tableDnDConfig&&a.tableDnDConfig.serializeRegexp&&(f=f.match(a.tableDnDConfig.serializeRegexp)[0],c+=d+"[]="+f)}return c},serializeTables:function(){var b=[];a("table").each(function(){this.id&&b.push(a.param(this.tableData(this)))});return b.join("&")},tableData:function(b){var c=b.tableDnDConfig,d=[],e=0,f=0,f=null,j={},k,i,g;if(!b)b=this.currentTable;if(!b||!b.id||!b.rows||!b.rows.length)return{error:{code:500,message:"Not a valid table, no serializable unique id provided."}};
g=c.autoCleanRelations&&b.rows||a.makeArray(b.rows);i=k=c.serializeParamName||b.id;b=function(a){return a&&c&&c.serializeRegexp?a.match(c.serializeRegexp)[0]:a};j[i]=[];!c.autoCleanRelations&&a(g[0]).data("level")&&g.unshift({id:"undefined"});for(var m=0;m<g.length;m++){if(c.hierarchyLevel){f=a(g[m]).data("level")||0;if(0==f)i=k,d=[];else if(f>e)d.push([i,e]),i=b(g[m-1].id);else if(f<e)for(var l=0;l<d.length;l++)d[l][1]==f&&(i=d[l][0]),d[l][1]>=e&&(d[l][1]=0);e=f;a.isArray(j[i])||(j[i]=[])}(f=b(g[m].id))&&
j[i].push(f)}return j}};j.jQuery.fn.extend({tableDnD:a.tableDnD.build,tableDnDUpdate:a.tableDnD.updateTables,tableDnDSerialize:a.proxy(a.tableDnD.serialize,a.tableDnD),tableDnDSerializeAll:a.tableDnD.serializeTables,tableDnDData:a.proxy(a.tableDnD.tableData,a.tableDnD)})})(window.jQuery,window,window.document);
