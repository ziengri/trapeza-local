<?php 
global $setting;
$waterPosition = ($setting['waterPosition'] ? ($setting['waterPosition']==5 ? "0" : $setting['waterPosition']) : 4);

if (!$inside_admin) actionObject($classID, $message, $f_Checked, $Checked);

clearCache($classID,$sub);

if (!$inside_admin) objsys($bc_objsys,$classID,$message);

@require_once($INCLUDE_FOLDER."classes/nc_imagetransform.class.php");
if ($_FILES['f_photo_preview'][size] != 0 ) {
  $photo_path = $DOCUMENT_ROOT.nc_file_path($classID, $message,'photo_preview', "");
  $imsize = getimagesize($photo_path);
  $ww = $setting[size2003_imagepx] ? $setting[size2003_imagepx] : 450;  $hh = 3000;
  if ($photo_path) {
    if ($ww<$imsize[0] || $hh<$imsize[1]) nc_ImageTransform::imgResize($photo_path, $photo_path, $ww, $hh, 0, 'jpg', 95, $message, 'photo_preview');
  }
}
if ($pathInc && file_exists($DOCUMENT_ROOT.$pathInc.'/images/watermark.png')) { 
    $photos = $db->get_results("select Path, ID from Multifield where Size != '1' AND Message_ID = '$message' AND Field_ID = '2366'", ARRAY_A);
    if ($photos) {
        foreach($photos as $fot) {
            if (!$notWater) nc_ImageTransform::putWatermark_file($fot[Path], $pathInc.'/images/watermark.png', $waterPosition );
            $db->query("UPDATE Multifield set Size = '1' where ID = '$fot[ID]'");
        }
    }
}

    /** Сохранение тэгов */
    $tag_list = $tag_list ?? [];
    (function() use ($tag_list, $message, $classID) {
        $tagProvider = new \App\modules\Korzilla\Tag\Provider();

        $tagList = $tagProvider->tagGetList();

        $filter = $tagProvider->filterGet();
        $filter->objectId[] = $message;
        $filter->objectType[] = $classID;

        $objectBindList = $tagProvider->bindGetList($filter);

        foreach ($tag_list as $tagId => $unused) {
            if (!isset($tagList[$tagId])) continue;

            $bind = $tagProvider->bindCreate($tagList[$tagId], $message, $classID);

            $isExists = false;

            foreach ($objectBindList as $bindId => $bindOld) {
                if (
                    $bindOld->tag_id === $bind->tag_id
                    && $bindOld->object_id === $bind->object_id
                    && $bindOld->object_type === $bind->object_type
                ) {
                    $isExists = true;
                    unset($objectBindList[$bindId]);
                    break;
                }
            }

            if (!$isExists) {
                $tagProvider->bindSave($bind);
            }
        }

        foreach ($objectBindList as $bind) {
            $tagProvider->bindRemove($bind);
        }
    })();


if($inside_admin) {
    ob_end_clean();
    header('Location: '.$goBackLink.'&inside_admin=1');
    exit;
} else { 
    echo json_encode(ARRAY(
        "title" => "ОК",
        "succes" =>  NETCAT_MODERATION_MSG_OBJCHANGED,
        "reload" => 1
    ));
}
?>