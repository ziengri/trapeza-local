<?php
$connectTemplate = $DOCUMENT_ROOT.$pathInc2."/template/class/sys/AddActionTemplate.html";
if ($current_catalogue['customCode'] && file_exists($connectTemplate)){
    include($connectTemplate);
}
else {
    global $setting, $settingCont;
    $cityname = ($cityname ? $cityname : $_COOKIE['cityname']);
    if (!$setting) $setting = getSettings();

    if (!$settingCont) $settingCont = $db->get_row("select a.*, a.Message_ID as mesid from Message2024 as a, Subdivision as b where b.Catalogue_ID = '$catalogue' AND a.Subdivision_ID=b.Subdivision_ID order by a.Created limit 0,1", ARRAY_A);

    /*$toemailArr =  explode(",",($cc_settings['EmailTo'] ? $cc_settings['EmailTo'] : ($settingCont['email'] ? $settingCont['email'] : $system_env['SpamFromEmail'])));
    $toemail = trim($toemailArr[0]);*/
    $toemail = ($cc_settings['EmailTo'] ? $cc_settings['EmailTo'] : ($setting['email'] ? $setting['email'] : $system_env['SpamFromEmail']));

    $sitehost = str_replace("www.","",$_SERVER['HTTP_HOST']);
    $frommail = getDomenMail();


    //ref_code($message);

    if ($_FILES['f_ForumAvatar']['size'] != 0 && $_FILES['f_ForumAvatar']['type'] != '')  {
    	eval(listQuery("SELECT CustomSettings FROM Sub_Class WHERE Sub_Class_ID='$cc'","\$data[CustomSettings]"));

        require_once($nc_core->INCLUDE_FOLDER . "classes/nc_imagetransform.class.php");

        $photo_path = $DOCUMENT_ROOT . nc_file_path('User', $message, 'ForumAvatar');
        if ($photo_path) {
    		nc_ImageTransform::imgResize($photo_path, $photo_path, $CustomSettings['avatar_height'] ? $CustomSettings['avatar_height'] : 100, $CustomSettings['avatar_width'] ? $CustomSettings['avatar_width'] : 100);
    	}
    }


    $settings = $nc_core->get_settings('', 'auth');
    $mailer = new CMIMEMail();

    // подтверждение через почту
    if ( $settings['confirm'] ) {
      $mailinfo = $nc_auth->get_confirm_mail( $message );

      if ($setting['emailsend'] && $setting['emailpass']) {
        require_once $DOCUMENT_ROOT.'/bc/modules/default/SendMailSmtpClass.php';

        $from = array(
            $current_catalogue['Catalogue_Name'], // Имя отправителя
            $setting['emailsend'] // почта отправителя
        );

        $mailSMTP = new SendMailSmtpClass($setting['emailsend'], $setting['emailpass'], $setting['emailsmtp'], $setting['emailport'], "UTF-8");
        // отправляем письмо
        $result =  $mailSMTP->send($f_Email, "Подтверждение аккаунта", $mailinfo['body'], $from);

      } else {
          $mailer = new CMIMEMail();
          $mailer->mailbody( strip_tags($mailinfo['body']), $mailinfo['html'] ?  $mailinfo['body'] : "");
          $mailer->send($f_Email, $frommail, $frommail, "Подтверждение аккаунта",  $current_catalogue['Catalogue_Name']);
      }
      if ($json) {
          echo json_encode(ARRAY(
            "title" => "Спасибо!",
            "succes" => "На Ваш почтовый ящик было выслано письмо со ссылкой для подтверждения регистрации. Не забудьте проверить папку СПАМ.",
            "field" => "clear"
          ));
      } else {
          echo "На Ваш почтовый ящик было выслано письмо со ссылкой для подтверждения регистрации. Не забудьте проверить папку СПАМ.<br/>";
      }
    }else if ($settings['premoderation']) {
        // премодерация администратором
      if ($json) {
          echo json_encode(ARRAY(
            "title" => "Спасибо!",
            "succes" => "Ваша учетная запись будет активирована после проверки администратора.",
            "field" => "clear"
          ));
      } else {
          echo "Ваша учетная запись будет активирована после проверки администратора.<br/>";
      }
    }

    // подтверждение не нужно
    if (!$settings['premoderation'] && !$settings['confirm']) {
      if ($json) {
          echo json_encode(ARRAY(
            "title" => "Спасибо!",
            "succes" => ($answer ? $answer : "Спасибо, Вы зарегистрированы!"),
            "field" => "clear"
          ));
      } else {
          echo "Регистрация прошла успешно.<br/>";
      }

      // авторизация после регистрации
      if ( $settings['autoauthorize'] ) {
        $nc_core->user->authorize_by_id($message);
        if (!$json) {
            echo "Сейчас Вы будете перемещены на главную страницу.<br/>";
            echo "<meta http-equiv='refresh' content='2;url=http://".$_SERVER['HTTP_HOST']."/' />";
        }
      }
    }

    // оповещение администратора
    if ( $settings['notify_admin'] ) {
        $mailinfo = $nc_auth->get_notify_admin_mail( $message );

        $mailer->mailbody( strip_tags($mailinfo['body']), $mailinfo['html'] ? $mailinfo['body'] : "");
        $mailer->send($toemail, $frommail, $frommail, $mailinfo['subject'], $current_catalogue['Catalogue_Name']);
    }
}
?>