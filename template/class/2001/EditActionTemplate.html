<?php 
global $setting, $AUTH_USER_ID, $db, $DOCUMENT_ROOT, $pathInc, $pathInc2;

$seporateFile = $DOCUMENT_ROOT.$pathInc2."/template/{$classID}/templateEdit/EditActionTemplate.html";
if ($current_catalogue['customCode'] && file_exists($seporateFile)) {
	include $seporateFile;
} else {
	if (!$inside_admin) actionObject($classID, $message, $f_Checked, $Checked);

	$waterPosition = ($setting[waterPosition] ? ($setting[waterPosition]==5 ? "0" : $setting[waterPosition]) : 4);

	if (!$inside_admin) objsys($bc_objsys,$classID,$message);
	clearCache('','', '', $catalogue);
	if ($removeID) removeObj($message,$classID,$removeID);

	$sub_id = $db->get_var("SELECT `Subdivision_ID` FROM `Message2001` WHERE `Message_ID` = {$message} AND `Catalogue_ID` = {$catalogue}");

	// Если это основной товара сделать другие товары его вариантами.
	if (!$f_variablenameSide) {
		$db->query(
			"UPDATE 
				Message2001 
			SET 
				variablenameSide = 1 
			WHERE 
				Subdivision_ID = {$sub_id} 
				AND name = '{$f_name}'
				AND Message_ID != {$message}
				AND `Catalogue_ID` = {$catalogue}");
	}

	# варианты товаров
	foreach($variable as $id => $value) {
		$side = $db->get_var("SELECT `variablenameSide` FROM `Message2001` WHERE `Message_ID` = {$id} AND `Catalogue_ID` = {$catalogue}") == '0';
		$variable[$id]['side'] = $side ? '0' : '1';
	}
	global $old_name;

	$product = [
		'id' => $message, 
		'variable' => $variable, 
		'newvariable' => $newvariable, 
		'main_name' => $f_name, 
		'changeAll' => isset($changeAll), 
		'sub_id' => $sub_id, 
		'old_name'=> $old_name ?: $f_name
	];

	$side = $db->get_var("SELECT COUNT(*) FROM `Message2001` 
																			WHERE `name` = '{$product['main_name']}' AND `Subdivision_ID` = {$product['sub_id']} AND `variablenameSide` = '0'
																			AND `Catalogue_ID` = {$catalogue} AND `Message_ID` != {$product['id']}") == 0; #true - 0 false - > 1
	if($side) $product['variable'][$product['id']]['side'] = '0';

	variableItems($product, 'edit');

	if ($pathInc && file_exists($DOCUMENT_ROOT.$pathInc.'/images/watermark.png')) {
		@require_once($INCLUDE_FOLDER."classes/nc_imagetransform.class.php");
		$previewWater = array(); // кому ставить вод.знак на превью

		//$otheritem = $db->get_results("select Message_ID from Message2001 where Checked = 1 AND Subdivision_ID = '$sub'",ARRAY_A);
		
		// взяли все товары
		$otheritem = $db->get_results("select Message_ID from Message2001 where Catalogue_ID = '$catalogue' LIMIT 0,500",ARRAY_A);
		if ($otheritem) {
			foreach($otheritem as $mes) {
				$msgs[] = $mes['Message_ID'];
			}
		}
		//ищем все фото без вод знака
		$photos = $db->get_results("select * from Multifield where Size != '1' AND Size != '2' AND (Message_ID = '$message'".($msgs ? " OR Message_ID IN (".implode(",",$msgs).")" : NULL).") AND Field_ID = '2353'", ARRAY_A);
		if ($photos) {
			foreach($photos as $fot) {
				if (!$notWater) {
					nc_ImageTransform::putWatermark_file($fot[Path], $pathInc.'/images/watermark.png', $waterPosition);
					if (in_array($catalogue, $previewWater)) nc_ImageTransform::putWatermark_file($fot[Preview], $pathInc.'/images/watermark.png', $waterPosition);
					$dd .= $fot[Path];
				}
				$db->query("UPDATE Multifield set Size = '1' where ID = '$fot[ID]'");
			}
		}
	}

	// фотки с гугла
	if ($googlephoto && count($googlephoto)>0) {
		savePhotoByGoogle($message, $googlephoto);
	}

	/** Сохранение тэгов */
	$tag_list = $tag_list ?? [];
	(function() use ($tag_list, $message, $classID) {
		$tagProvider = new \App\modules\Korzilla\Tag\Provider();
  
		$tagList = $tagProvider->tagGetList();
  
		$filter = $tagProvider->filterGet();
		$filter->objectId[] = $message;
		$filter->objectType[] = $classID;
  
		$objectBindList = $tagProvider->bindGetList($filter);
  
		foreach ($tag_list as $tagId => $unused) {
			if (!isset($tagList[$tagId])) continue;
  
			$bind = $tagProvider->bindCreate($tagList[$tagId], $message, $classID);
  
			$isExists = false;
  
			foreach ($objectBindList as $bindId => $bindOld) {
				if (
					$bindOld->tag_id === $bind->tag_id
					&& $bindOld->object_id === $bind->object_id
					&& $bindOld->object_type === $bind->object_type
				) {
					$isExists = true;
					unset($objectBindList[$bindId]);
					break;
				}
			}
  
			if (!$isExists) {
				$tagProvider->bindSave($bind);
			}
		}
  
		foreach ($objectBindList as $bind) {
			$tagProvider->bindRemove($bind);
		}
	})();

	if($inside_admin) {
		ob_end_clean();
		header('Location: '.$goBackLink.'&inside_admin=1');
		exit;
	} else {
		if($AUTH_USER_ID==253){
			echo json_encode(ARRAY(
				"title" => "ОК",
				"fds" => $dd,
				//"modal" => "close",
				//"reload" => "1",
				"succes" =>  NETCAT_MODERATION_MSG_OBJCHANGED
			));
		}else{
			echo json_encode(ARRAY(
				"title" => "ОК",
				"modal" => "close",
				"reload" => "1",
				"succes" =>  NETCAT_MODERATION_MSG_OBJCHANGED
			));
		}

	}
}
