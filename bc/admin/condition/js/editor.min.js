function nc_condition_editor(f){this.init(f)}
(function(f){function t(a){return"and"===a.type||"or"===a.type}var g=nc_condition_editor,c=g.prototype,e=nc_condition_messages,x=g.adminFilesPath=NETCAT_PATH+"admin/",h=g.filesPath=g.adminFilesPath+"condition/",h=g.dataPath=h+"data/";g.dataCache={};g.urls={SelectSubdivisionList:h+"json/subdivision_list.php?site_id=%siteId%&sub_class_id=%subClassId%",SelectItemList:h+"json/object_list.php?sub_class_id=%subClassId%",SelectItemPropertyList:h+"json/component_field_list.php?sub_class_id=%subClassId%",SelectFromClassifierList:h+
"json/classifier_values.php"};g.loadingInProgress={};c.siteId=null;c.subClassId=null;c.root=null;c.inputField=null;c.isInitializing=!1;c.defaultChosenParams={disable_search_threshold:10,no_results_text:e.SEARCH_NO_RESULTS};c.conditionGroupsToShow=[];c.conditionGroupsToExclude=[];c.conditionsToExclude=[];c.itemProperties={};var p=g.opEqNe={name:"op",type:"SimpleSelect",values:{eq:e.EQUALS,ne:e.NOT_EQUALS}},y=g.opContains={name:"op",type:"SimpleSelect",values:{contains:e.CONTAINS,notcontains:e.NOT_CONTAINS}},
u=g.opString={name:"op",type:"SimpleSelect",values:{eq:e.EQUALS,ne:e.NOT_EQUALS,contains:e.CONTAINS,notcontains:e.NOT_CONTAINS,begins:e.BEGINS_WITH}},q=g.opNumber={name:"op",type:"SimpleSelect",values:{ge:e.GREATER_OR_EQUALS,gt:e.GREATER_THAN,le:e.LESS_OR_EQUALS,lt:e.LESS_THAN,eq:e.EQUALS,ne:e.NOT_EQUALS}},z=g.opDateTime=q,h=g.opAll=f.extend({},u);f.extend(h.values,q.values);var h=g.makeSubdivisionField=function(a){return{name:a||"value",type:"SelectFromJson",source:g.urls.SelectSubdivisionList,placeholder:e.SELECT_SUBDIVISION}},
A=g.makeItemField=function(a){return{name:a||"value",type:"SelectFromJson",source:g.urls.SelectItemList,placeholder:e.SELECT_OBJECT}};c.conditionTypes={object_sub:{group:"GROUP_OBJECTS",label:"TYPE_SUBDIVISION",params:[e.TYPE_SUBDIVISION,p,h("value")]},object_parentsub:{group:"GROUP_OBJECTS",label:"TYPE_SUBDIVISION_DESCENDANTS",params:[e.TYPE_SUBDIVISION_DESCENDANTS,p,h("value")]},object:{group:"GROUP_OBJECTS",label:"TYPE_OBJECT",params:[e.TYPE_OBJECT,p,A("value")]},object_property:{group:"GROUP_OBJECTS",
label:"TYPE_OBJECT_FIELD",params:[e.TYPE_OBJECT_FIELD,{name:"field",type:"SelectItemProperty"},{type:"ItemPropertyOptions"}]}};var v=function(a){if(!a.getBoundingClientRect)return f(a).offset();var b=document.body,d=document.documentElement,l=window.pageYOffset||d.scrollTop||b.scrollTop,b=d.clientTop||b.clientTop||0;return Math.round(a.getBoundingClientRect().top+l-b)},B=function(a){return(a.closest(".condition").data("initialValues")||{})[a.attr("name")]},w=function(a,b){var d=b.chosen;setTimeout(function(){var a=
d.dropdown,a=v(a[0])+a.outerHeight(),b=f("body, html"),c=b.scrollTop()+f(window).height(),c=a-c;0<c&&(c=Math.min(b.scrollTop()+c,v(d.container[0])),b.animate({scrollTop:c},400),b.css("height",a+"px"))},100)};c.init=function(a){this.loadStylesIn(window);this.siteId=a.site_id;this.subClassId=a.sub_class_id;this.root=$nc(a.container).addClass("nc-condition-editor");this.inputField=$nc("<input type='hidden' name='"+a.input_name+"'/>").appendTo(this.root);var b=a.conditions;b&&!$nc.isEmptyObject(b)&&this.inputField.val(JSON.stringify(b));
this.conditionGroupsToShow=a.groups_to_show||[];this.conditionGroupsToExclude=a.groups_to_exclude||[];this.conditionsToExclude=a.conditions_to_exclude||[];this.load(b);$nc(window).resize($nc.proxy(this,"updateAllConditionLabelPositions"))};c.load=function(a){this.isInitializing=!0;var b=a||{};"string"===typeof a&&(b=JSON&&JSON.parse?JSON.parse(a):eval("("+a+")"));this.root.find(".condition-group").first().remove();this.addGroup(this.root,b);this.isInitializing=!1;var d=this;f(window).load(function(){d.updateAllConditionLabelPositions();
d.root.addClass("enable-transitions")})};c.save=function(){var a=this.root.children(".condition-group"),b=(a=this.getGroupData(a))?JSON.stringify(a):"";this.inputField.val(b);return a};c.onFormSubmit=function(){return this.checkConditions()?(this.save(),!0):!1};c.getGroupData=function(a){var b={type:a.find(".operator-cell select").val(),conditions:[]};a=a.find(".condition-cell").first().children(".condition, .condition-group");var d=this;if(0==a.length)return null;a.each(function(){var a=f(this);
(a=a.hasClass("condition-group")?d.getGroupData(a):d.getConditionData(a))&&b.conditions.push(a)});return b};c.getConditionData=function(a){var b=a.data("initialValues"),d=!1;a.find(".condition-param-value").not(".condition-param-value-initializing").each(function(){var a=f(this),c=a.val();if(""==c||null==c)return console&&console.warn("Condition parameter %s has no value, the condition is ignored (type=%s)",this.name,b.type),d=!0,!1;a.hasClass("condition-param-value-date")&&a.datepicker&&(c=a.datepicker("getISODate")||
c);b[this.name]=c;return!0});b.type=a.data("conditionType");return d?null:b};c.checkConditions=function(){var a=!0;this.root.find(".condition-param-value").not(".condition-param-value-initializing").each(function(){var b=f(this),d=b.val();if(""==d||null==d)return a=!1,d=b.closest(".condition").find(".condition-string").first().text(),alert(e.VALUE_REQUIRED.replace("%s",d)),b.is("select")?b.data("chosen").selected_item.focus():b.is("input:hidden")?b.siblings("a.condition-param-popup").focus():b.focus(),
!1});return a};c.loadStylesIn=function(a){0==a.$nc("#nc_condition_editor_stylesheet").length&&a.$nc("head").append('<link rel="stylesheet" id="nc_condition_editor_stylesheet" type="text/css" href="'+x+'js/datepicker/datepicker.css">')};c.addGroup=function(a,b){var d=this,l=f("<div class='condition-group'><div class='condition-group-container'><div class='operator-cell'><div class='operator-label nc-label nc--blue'>"+e.AND+"</div><select class='operator-type'><option value='and'>"+e.AND_DESCRIPTION+
"</option><option value='or'>"+e.OR_DESCRIPTION+"</option></select><a class='nc-icon-s nc--remove remove-group-button'></a></div><div class='condition-cell'></div><div class='buttons-cell'><a class='add-condition-button'>"+e.ADD+"</a></div></div></div>"),c=l.find(".condition-cell"),g=l.find("select");l.find(".add-condition-button").click(function(){d.showAddConditionDialog(c)});l.find(".remove-group-button").click(function(){d.removeGroup(l)}).attr("title",e.REMOVE_GROUP);l.find(".operator-type").change(function(){d.updateConditionLabelText(f(this))});
l.find(".operator-label").click(function(){d.changeOperator(f(this))});var k=a.parents(".condition-group"),m=!k.length;m&&l.addClass("root");k.length%2&&l.find(".condition-group-container").addClass("even-level");a.append(l);g.chosen(this.defaultChosenParams);if(f.isEmptyObject(b))m&&l.find(".operator-cell").hide();else{g.val(b.type).change().trigger("chosen:updated");for(var g=0,h=b.conditions.length;g<h;g++){var r=b.conditions[g];t(r)?this.addGroup(c,r):this.addCondition(r.type,c,r)}m&&1===h&&!t(b.conditions[0])&&
l.find(".operator-cell").hide()}this.updateOperatorLabelPosition(k.first())};c.showAddConditionDialog=function(a){var b=["<option></option>","<option value='addGroup' class='create-group-option'>"+e.ADD_GROUP+"</option>"],d=null,l;for(l in this.conditionTypes){var c=this.conditionTypes[l],g=this.conditionGroupsToShow;g.length&&-1==f.inArray(c.group,g)||-1!=f.inArray(c.group,this.conditionGroupsToExclude)||-1!=f.inArray(l,this.conditionsToExclude)||(d!=c.group&&(null!=d&&b.push("</optgroup>"),b.push('<optgroup label="'+
e[c.group]+'">'),d=c.group),b.push('<option value="'+l+'">'+e[c.label]+"</option>"))}b.push("</optgroup>");var k=f('<select data-placeholder="'+e.SELECT_CONDITION_TYPE+'">'+b.join("")+"</select>"),h=f('<div class="add-condition-type-select"></div>').append(k).appendTo(a),n=this;k.chosen(this.defaultChosenParams).on("chosen:hiding_dropdown",function(){var a=k.val(),b=k.closest(".condition-cell");k.parents(".add-condition-type-select").remove();"addGroup"==a?n.addGroup(b,null):a&&n.addCondition(a,b,
{})}).on("chosen:showing_dropdown",w);setTimeout(function(){h.find(".chosen-container").trigger("mousedown")},1)};c.updateAllConditionLabelPositions=function(){var a=this;this.root.find(".condition-group").each(function(){a.updateOperatorLabelPosition(f(this))})};c.updateOperatorLabelPosition=function(a){if(!this.isInitializing){var b=a.find(".condition-cell").first().children(".condition, .condition-group"),d=a.find(".operator-cell").first(),c=d.find(".operator-label");if(1<b.length)if(a.is(".root")&&
!d.is(":visible"))d.slideDown(400,f.proxy(this,"updateAllConditionLabelPositions")).show();else{a=c.hasClass("visible");var d=b.first(),e=d.position().top,b=b.last(),g=b.position().top,k=e+27+.5*(g-e-c.height());d.is(".condition-group")&&(k+=12);b.is(".condition-group")&&(k+=12);k=Math.min(e+f(window).height()-100,Math.round(k))+"px";c.addClass("visible");a?setTimeout(function(){c.css("top",k)},1):c.css("top",k)}else c.removeClass("visible"),a.is(".root")&&d.is(":visible")&&d.slideUp(400,f.proxy(this,
"updateAllConditionLabelPositions"))}};c.updateConditionLabelText=function(a){a.closest(".operator-cell").find(".operator-label").html(e[a.val().toUpperCase()])};c.changeOperator=function(a){a=a.closest(".operator-cell").find(".operator-type");a.val("and"==a.val()?"or":"and").change().trigger("chosen:updated")};c.addCondition=function(a,b,d){var c=this.conditionTypes[a];a=f("<div />",{"class":"condition condition-"+a,data:{conditionType:a,initialValues:d}}).appendTo(b);var g=this;this.addFields(a,
c.params,d);f("<a class='nc-icon-s nc--remove remove-condition-button'></a>").click(function(){g.removeCondition(f(this).closest(".condition"))}).attr("title",e.REMOVE_CONDITION).appendTo(a);this.updateOperatorLabelPosition(b.closest(".condition-group"));this.isInitializing||a.find("input, select").not(":hidden").first().focus()};c.addFields=function(a,b,d){for(var c=this,e=d&&!f.isEmptyObject(d),h=0,k=b.length;h<k;h++){var m=b[h];if("string"===typeof m)a.append("<span class='condition-string'>"+
m+"</span>");else{var n="append"+m.type+"Field";void 0===this[n]?console&&console.warn("Incorrect field type '%s': no %s method",m.type,n):this[n](a,m,e?d[m.name]:m.value).wrap(f("<span/>",{"class":"condition-param"}))}}a.find("select").chosen(this.defaultChosenParams).on("chosen:showing_dropdown",w).each(function(){var a=f(this);if(a.data("loadData")){var b=a.data("fieldParams")||{},d=f.proxy(c,"on"+b.type+"ListReady"),b=c.makeFullUrl(b.source||g.urls[b.type+"List"],b.requestParams);c.loadData(b,
d,a.data("callbackParams"))}});a.find("input.condition-param-value-date").datepicker()};c.removeGroup=function(a){var b=0<a.find(".condition").length,d=a.hasClass("root")?e.REMOVE_ALL_CONFIRMATION:e.REMOVE_GROUP_CONFIRMATION;if(!b||confirm(d))a.remove(),this.root.find(".condition-group").length?this.updateAllConditionLabelPositions():this.addGroup(this.root,null)};c.removeCondition=function(a){var b=!1;a.find(".condition-param-value").not(".condition-param-value-initializing").each(function(){var a=
f(this).val();if(""==a||null==a)return b=!0,!1});var d=[];a.find(".condition-string, .condition-param-value:not([type=hidden]), .essence-caption").each(function(){var a=f(this);a.is(".condition-string, .essence-caption")?d.push(a.text()):a.is("select")?d.push("["+f.trim(a.find("option:selected").text())+"]"):d.push(a.val())});if(b||confirm(e.REMOVE_CONDITION_CONFIRMATION.replace("%s",d.join(" "))))a.remove(),this.updateAllConditionLabelPositions()};c.appendSimpleSelectField=function(a,b,d){var c=
['<select name="'+b.name+'">'],e;for(e in b.values)c.push('<option value="'+e+'">'+b.values[e]+"</option>");c.push("</select>");b=f(c.join("")).addClass("condition-param-value");(d||0===d)&&b.val(d);return b.appendTo(a)};c.createListSelectField=function(a,b,d){return f("<select />",{name:a.name,"class":"condition-param-value condition-param-value-initializing condition-param-"+a.type}).data({loadData:!0,fieldParams:a}).attr("data-placeholder",d)};c.appendSelectItemPropertyField=function(a,b,d){return this.createListSelectField(b,
d,e.SELECT_OBJECT_FIELD).appendTo(a)};c.appendSelectFromClassifierField=function(a,b,d){var c=b.requestParams.classifier;return this.createListSelectField(b,d,e.SELECT_VALUE).data("callbackParams",{classifier:c}).addClass("condition-param-SelectFromClassifier-"+c).appendTo(a)};c.appendItemPropertyOptionsField=function(a,b,d){return f("<span class='condition-itemproperty-variable-part' />").appendTo(a)};c.appendInputField=function(a,b,d){return f("<input />",{type:b.inputType||"text",name:b.name,value:d,
autocomplete:"off","class":"condition-param-value"+(b["class"]?" "+b["class"]:"")}).appendTo(a)};c.appendDateTimeInputField=function(a,b,d){return f("<input />",{type:"text",name:b.name,value:d,"class":"condition-param-value condition-param-value-date"}).appendTo(a)};c.getSelectFromJsonClass=function(a){for(var b=0,d=0,c=a.length;d<c;d++)b=(b<<5)-b+a.charCodeAt(d),b&=b;b=b.toString(36).replace("-","N");return"condition-param-SelectFromJson-"+b};c.appendSelectFromJsonField=function(a,b,d){var c=this.makeFullUrl(b.source,
b.requestParams);return this.createListSelectField(b,d,b.placeholder).addClass(this.getSelectFromJsonClass(c)).appendTo(a)};c.loadData=function(a,b,d){b||(b=f.noop);g.loadingInProgress[a]||("undefined"===typeof g.dataCache[a]?(g.loadingInProgress[a]=!0,f.getJSON(a,function(c){g.dataCache[a]=c;b(c,a,d);g.loadingInProgress[a]=!1})):b(g.dataCache[a],a,d))};c.makeFullUrl=function(a,b){var d=a;b&&(d+=(0<=d.indexOf("?")?"&":"?")+f.param(b));return d.replace("%siteId%",this.siteId).replace("%subClassId%",
this.subClassId)};c.fillSelectsWithOptions=function(a,b){var d=this.root.find(a);if(0<d.length){var c=["<option></option>"];if(f.isArray(b))for(var e=0,g=b.length;e<g;e++)c.push('<option value="'+b[e].key+'">'+b[e].value+"</option>");d.append(c.join(""));this.reinitializeChosenSelects(d)}};c.reinitializeChosenSelects=function(a){a.each(function(){var a=f(this),d=a.data("chosen");a.data("hadFocus",d?d.container.hasClass("chosen-container-active"):a.is(":focus"));a.val(B(a)).removeClass("condition-param-value-initializing")}).chosen("destroy").chosen(this.defaultChosenParams).each(function(){var a=
f(this);a.data("hadFocus")&&a.data("chosen").selected_item.focus();a.removeData("hadFocus")})};c.onSelectFromClassifierListReady=function(a,b,d){this.fillSelectsWithOptions("select.condition-param-SelectFromClassifier-"+d.classifier+":empty",a)};c.onSelectItemPropertyListReady=function(a,b,d){this.itemProperties=a;b=["<option></option>"];for(var c in a){b.push('<optgroup label="'+c+'">');d=0;for(var e=a[c].length;d<e;d++){var g=a[c][d];b.push("<option value='"+g.id+"'>"+g.description+"</option>")}b.push("</optgroup>")}a=
this.root.find("select.condition-param-SelectItemProperty:empty");a.append(b.join("")).change(f.proxy(this,"onItemPropertySelect"));this.reinitializeChosenSelects(a);a.trigger("change")};c.generatePropertyFieldConfiguration=function(a){var b=[];switch(a.type){case "string":case "text":b.push(u,{name:"value",type:"Input"});break;case "integer":b.push(q,{name:"value",type:"Input",inputType:"number"});break;case "float":b.push(q,{name:"value",type:"Input"});break;case "select":case "multiselect":b.push("multiselect"===
a.type?y:p,{name:"value",type:"SelectFromClassifier",requestParams:{classifier:a.classifier}});break;case "boolean":b.push('<input type="hidden" name="op" value="eq" class="condition-param-value">'+e.EQUALS,{name:"value",type:"SimpleSelect",values:{1:e.TRUE,0:e.FALSE}});break;case "datetime":b.push(z,{name:"value",type:"DateTimeInput"})}return b};c.onItemPropertySelect=function(a){var b=f(a.target);if(a=this.getItemPropertyData(b.val())){var c=b.closest(".condition"),b=c.find(".condition-itemproperty-variable-part"),
c=c.data("initialValues");a=this.generatePropertyFieldConfiguration(a);b.html("");this.addFields(b,a,c)}};c.getItemPropertyData=function(a){var b=this.itemProperties,c;for(c in b)for(var e=0,f=b[c].length;e<f;e++){var g=b[c][e];if(g.id==a)return g}return null};c.onSelectFromJsonListReady=function(a,b,c){b=this.getSelectFromJsonClass(b);this.fillSelectsWithOptions("select."+b+":empty",a)}})($nc);
