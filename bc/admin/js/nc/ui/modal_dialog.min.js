(function(){function g(a){if(!(this instanceof g))return new g(a);this.options=c.extend(!0,{},this.options);this.set_options(a);this.options.url||(this.is_loaded=!0);return this}function m(a){return"simplemodal-container--"+(a||f)}function q(){var a=g.get_opened_dialog();if(null!==a){var b=a.options.persist,d=c("#simplemodal-placeholder");b&&this.d.placeholder?d.replaceWith(this.d.data.removeClass("simplemodal-data").css("display",this.display)):(d.remove(),a.dialog_container.remove());c("#simplemodal-container, #simplemodal-overlay").remove();
this.d={};(h=g.get_previous_dialog())?(f=h.index,a=h.dialog_container.closest(".simplemodal-container").attr("id","simplemodal-container"),this.d=a.data("modal_d"),this.o=a.data("modal_o"),this.occb=!1,this.unbindEvents(),this.bindEvents(),c(".simplemodal-overlay").last().attr("id","simplemodal-overlay")):(f=0,window.autosave&&(autosave.stopTimer(),autosave=null))}}function r(a){27===a.keyCode&&(a=c(a.target),a.is(":input")&&a.blur(),g.get_opened_dialog().close())}function n(a){if(!window.nc_autosave_use||
!window.InitAutosave)return!1;a=a.get_form();return"adminForm"===a.attr("id")&&!!a.find(':hidden[name="message"]').val()&&!!a.find(':hidden[name="cc"]').val()}function k(a){return'[data-tab-id="'+a+'"]'}function p(a,b,c){a&&((new RegExp("[?&]"+b+"=")).test(a)||(a+=(0<=a.indexOf("?")?"&":"?")+b+"="+c));return a}function t(a){return"boolean"!==typeof a?!/^(no|false|0)$/i.test(a.toString()):a}if("undefined"!==typeof nc&&nc===nc.root){var c=nc.root.$;c(window).on("resize.modal_dialog",function(){c(".simplemodal-container").each(function(){var a=
c(this).data("modal_dialog");a&&a.resize&&a.resize()})});var h=null,f=0;g.get_opened_dialog=function(){return h&&h.is_open?h:null};g.get_current_dialog=function(){return h};g.get_previous_dialog=function(){for(var a=f;0<--a;){var b=c("#"+m(a)).data("modal_dialog");if(b)return b}return null};g.prototype={constructor:g,options:{focus:!0,url:null,parameters:null,persist:!1,confirm_close:!0,on_show:c.noop,on_resize:c.noop,on_submit_response:null,width:null,height:null,min_width:600,max_width:1200,full_markup:'<div class="nc-modal-dialog"><div class="nc-modal-dialog-header"><h2>&nbsp;</h2></div><div class="nc-modal-dialog-body"></div><div class="nc-modal-dialog-footer"></div></div>',
hidden_tabs:null,show_close_button:!0,on_tab_change:{}},loaded_markup:null,dialog_container:null,parts:{header:".nc-modal-dialog-header",title:".nc-modal-dialog-header h2",header_tabs:".nc-modal-dialog-header-tabs",body:".nc-modal-dialog-body",body_tabs:".nc-modal-dialog-body-tab",footer:".nc-modal-dialog-footer"},is_loaded:!1,is_open:!1,are_tabs_initialized:!1,has_header:!0,has_unsaved_changes:!1,index:0,set_options:function(a){this.options=c.extend(this.options,a)},set_option:function(a,b){this.options[a]=
b},get_option:function(a){return this.options[a]},set_on_tab_change:function(a,b){"function"===typeof b&&(this.options.on_tab_change.hasOwnProperty(a)?this.options.on_tab_change[a].push(b):this.options.on_tab_change[a]=[b])},load:function(){var a=this;nc.process_start("nc.ui.modal_dialog.load()");return c.ajax({method:this.options.method||"GET",url:this.options.url,data:c.extend({isNaked:1},this.options.parameters||{})}).done(function(b){a.loaded_markup=c.trim(b)}).always(function(){a.is_loaded=!0;
nc.process_stop("nc.ui.modal_dialog.load()",0)})},create:function(){if(!this.is_loaded)return this.load().done(c.proxy(this,"create"));var a=this.options,b;if(this.loaded_markup){var d=c(this.loaded_markup);d.is(".nc-modal-dialog")?b=d:(d=d.find(".nc-modal-dialog"),d.length&&(b=d))}b||(b=c(a.full_markup),this.loaded_markup&&b.find(".nc-modal-dialog-body").append(this.loaded_markup));a=b.find("script").remove();h=this;this.dialog_container=b.hide().appendTo("body");this.get_part("header").length||
(this.dialog_container.addClass("nc-modal-dialog-without-header"),this.has_header=!1);this.init_options();this.init_close_button();this.init_tabs();this.init_forms();this.init_buttons();b.append(a);return c.Deferred().resolve()},init_options:function(){var a=this.options,b=this.dialog_container,d;for(d in a){var e=b.data(d.replace(/_/g,"-"));void 0!==e&&e.toString().length&&(a[d]=e)}b=this.options.hidden_tabs;null===b?a.hidden_tabs=[]:c.isArray(b)||(a.hidden_tabs=[],c.each(b.match(/[\w-]+/g),function(b,
c){a.hidden_tabs.push(c)}));for(var l in{confirm_close:1,show_close_button:1})a[l]=t(a[l])},init_close_button:function(){this.options.show_close_button&&c('<a class="nc-modal-dialog-header-close-button" title="'+ncLang.Close+'" />').click(c.proxy(this,"close")).appendTo(this.get_part("header"))},init_buttons:function(){var a=this,b=this.get_part("footer").find("button").off("click.modal_dialog");b.filter("[data-action=close]").on("click.modal_dialog",c.proxy(this,"close"));b.filter("[data-action=submit]").on("click.modal_dialog",
function(){c(this).hasClass("nc--loading")||(nc.process_start("nc.ui.modal_dialog.submit_form()",this),a.submit_form())});b.filter('[data-action="save-draft"]').toggle(n(this)).on("click.modal_dialog",function(a){a.preventDefault();window.autosave&&(c(this).addClass("nc--loading"),autosave.saveAllData(autosave))})},init_tabs:function(){if(!this.are_tabs_initialized){this.are_tabs_initialized=!0;var a=this,b=this.get_part("body").find("[data-tab-caption]");a.dialog_container.toggleClass("nc-modal-dialog-without-tabs",
0===b.length);if(b.length){var d=this.get_part("header_tabs");d.length||(d=c('<div class="nc-modal-dialog-header-tabs"/>').appendTo(this.get_part("header")));var e=d.children("ul"),l=1;e.length||(e=c("<ul/>").appendTo(d));b.addClass("nc-modal-dialog-body-tab").hide().each(function(){var b=c(this).data("tab-id")||"tab"+l++,d=c(this).attr("data-tab-id",b);c("<li>",{"data-tab-id":b,html:d.data("tab-caption")}).appendTo(e).click(function(b){a.change_tab(c(b.target).data("tab-id"))})});c.each(this.options.hidden_tabs,
function(b,c){a.hide_tab(c)});this.change_tab(b.eq(0).data("tab-id"))}}},get_form:function(){var a=this.find("#adminForm");a.length||(a=this.find("form").first());return a},init_forms:function(){InitTransliterate();var a;a=/(MSIE|Trident)/.test(navigator.userAgent||"")&&/^https/i.test(window.location.href||"")?"javascript:false":"about:blank";var b=c.proxy(this,"process_form_submit_response");this.find("form").each(function(){var d=c(this);d.ajaxForm({beforeSerialize:nc_save_editor_values,success:b,
iframe:!0,iframeSrc:a});var e=d.attr("action"),e=p(e,"isNaked",1),e=p(e,"admin_modal",1);d.attr("action",e)})},init_change_tracking:function(){if(this.options.confirm_close){var a=this,b=function(){a.has_unsaved_changes=!0};this.has_unsaved_changes=!1;this.dialog_container.one("change",":input",b).one("input textinput","div[contenteditable]",b)}},submit_form:function(a){this.has_unsaved_changes=!1;a=a?c(a):this.get_form();a.submit()},process_form_submit_response:function(a,b,d,e){nc.process_stop("nc.ui.modal_dialog.submit_form()");
return(c.isFunction(this.options.on_submit_response)?this.options.on_submit_response:this.default_form_submit_response_handler).call(this,a,b,d,e)},default_form_submit_response_handler:function(a,b,d,e){if(b=nc_check_error(a))this.show_error(b);else{b=e.find("input[name=cc]").val()||e.find("input[name=infoblock_id]").val();e=window.location;d=(d=/^NewHiddenURL=(.+?)$/m.exec(a))?c.trim(d[1]):null;var l=/^SetLocationHash=(.*?)$/m.exec(a);l&&(window.location.hash=l[1]);/^ReloadPage=1$/m.test(a)?d&&!/\.php/.test(window.location.pathname)?
((a=/\/([^\/]+)$/.exec(e.pathname))&&(d+=a[1]),e.pathname=d):e.reload(!0):b&&nc_update_admin_mode_infoblock(b,c.proxy(this,"destroy"))}},show_error:function(a){var b=this.get_part("footer"),d=c("<div class='nc-alert nc--red' />").append(c("<div class='nc-alert-close nc-icon-s nc--remove'></div>").click(function(){d.remove()})).append("<i class='nc-icon-l nc--status-error'></i>").append(a).appendTo(b)},change_tab:function(a){var b=k(a),d=this.get_option("on_tab_change");this.get_part("header_tabs").find("li").removeClass("nc--active").filter(b).addClass("nc--active").show();
this.get_part("body_tabs").hide().filter(b).show();d.hasOwnProperty(a)&&c.each(d[a],function(a,b){b()});return this},hide_tab:function(a){a=k(a);this.get_part("header_tabs").find("li"+a).hide();this.get_part("body_tabs").filter(a).hide();return this},show_tab:function(a){a=k(a);this.get_part("header_tabs").find("li"+a).show();this.get_part("body_tabs").filter(a).show();return this},get_tab:function(a){return this.get_part("body").find(k(a))},get_current_tab:function(){var a=this.get_part("body_tabs");
return a.length?a.filter(":visible"):this.get_part("body")},hide_header_tabs:function(){this.dialog_container.addClass("nc-modal-dialog-without-tabs");return this},show_header_tabs:function(){this.dialog_container.removeClass("nc-modal-dialog-without-tabs");return this},open:function(){f&&(c("#simplemodal-container").attr("id",m()).data({modal_d:c.modal.impl.d,modal_o:c.modal.impl.o}),c("#simplemodal-overlay").attr("id",""),c.modal.impl.d={});f++;this.index=f;this.dialog_container?this.when_ready_to_open():
this.create().done(c.proxy(this,"when_ready_to_open"));return this},when_ready_to_open:function(){c.modal(this.dialog_container,{onOpen:null,onShow:c.proxy(this,"on_show"),onClose:q,autoPosition:!1,persist:this.options.persist,closeHTML:"",zIndex:1E4+10*f,focus:this.options.focus});c("#simplemodal-container").data("modal_dialog",this);c(window).off("keydown.modal_dialog").on("keydown.modal_dialog",r);this.is_open=!0;this.init_change_tracking();this.resize()},on_show:function(){this.options.on_show(this);
n(this)&&InitAutosave("adminForm")},close:function(){if(this.is_open&&this.is_close_confirmed()){if(this.index===f)c.modal.close();else{var a=c("#"+m(this.index));a.prev(".simplemodal-overlay").remove();a.remove()}this.is_open=!1;this.options.persist||this.destroy();1>=this.index&&c(window).off("keydown.modal_dialog")}},is_close_confirmed:function(){return this.options.confirm_close&&this.has_unsaved_changes?confirm(window.TEXT_SAVE||"\u0412\u044b\u0439\u0442\u0438 \u0431\u0435\u0437 \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u044f?"):
!0},resize:function(){if(!this.is_open)return this;var a=c(window.top.window),b=this.options,d=a.width(),e=window.innerHeight||window.clientHeight||a.height(),g=e-200,f=b.width||d-200,h=b.height||g,k="auto"===h,a=this.dialog_container.closest(".simplemodal-container"),m=Math.ceil;f>b.max_width&&(f=b.max_width);!b.width&&f<b.min_width&&(f=b.min_width);a.css({width:f+"px",height:h+(k?"":"px"),left:m((d-f)/2-10)+"px",top:"120px"}).find(".simplemodal-wrap").css("overflow","auto");k&&(a.height()>g&&a.css("height",
g+"px"),a.css("top",Math.max(m((e-a.height())/2),100)+"px"));d=this.get_part("body").find(".nc--fill");d.length&&d.css("height",a.height()+"px");b.on_resize();return this},destroy:function(){this.close();window.CKEDITOR&&this.dialog_container.find("textarea").each(function(){this.name in CKEDITOR.instances&&CKEDITOR.remove(CKEDITOR.instances[this.name])});this.dialog_container.remove()},clear_all:function(){for(var a in this.parts)this.clear(a)},clear_part:function(a){this.get_part(a).empty()},find:function(a){this.dialog_container||
this.create();return this.dialog_container.find(a)},get_part:function(a){return this.find(this.parts[a])}};nc.ext("modal_dialog",g,"ui")}})(window);
