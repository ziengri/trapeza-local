(function(e,t){var n={};e.ui.dashboard&&(e.ui.dashboard=n);var r=null,i=function(t,n,r,i){return e.key_exists(r,t)?t[r]:e.key_exists(r,n)?n[r]:i};n.widget_types={};n.user_widgets={};n.init=function(i,s,o){var u=o.grid_margin,a=o.grid_size;n.opt=o;n.widget_types=i;n.user_widgets=s;r=t("#nc-dashboard>div").gridster({widget_margins:[u,u],widget_base_dimensions:[a,a],widget_selector:"div",extra_rows:0,extra_cols:0,autogenerate_stylesheet:!0,avoid_overlapped_widgets:!1,serialize_params:function(e,t){var n=t.el.widget_settings;return n?{type:n.type,col:t.col,row:t.row,size:[t.size_x,t.size_y],color:n.color,query:n.query}:t},draggable:{stop:function(){e.event.call(["dashboard","move"])}}}).data("gridster");r.disable();n.toggle_add_btn=function(){e.root(function(){var t=e.root("#mainViewButtons div.nc_dashboard_add_widget"),i=function(e){var t=0;for(var n in e)e.hasOwnProperty(n)&&t++;return t};i(n.widget_types)===i(r.serialize())?t.addClass("nc--disabled"):t.removeClass("nc--disabled")})};n.toggle_add_btn();e.event("dashboard",function(e){n.toggle_add_btn();n.save_user_widgets();e.selector.join(".")==="dashboard.close"&&setTimeout(n.save_user_widgets,1e3)});for(var f=0;f<s.length;f++){var l=t("#widget_"+f);l.length&&n.register_widget(s[f],l,!1)}n.append_widget_tabs()};n.save_user_widgets=function(){e.process_start("dashboard.save_user_widgets()");var n=JSON.stringify(r.serialize());t.ajax({type:"POST",url:e.config("admin_path")+"dashboard/ajax.php?action=save_user_widgets",data:{user_widgets:n},dataType:"json",success:function(){e.process_stop("dashboard.save_user_widgets()")}})};n.append_widget_tabs=function(){var i=r.serialize(),s,o,u=t("#nc-dashboard-full div.nc-nav-tabs");for(var a=0;a<i.length;a++){s=n.widget_types[i[a].type];if(e.key_exists("fullscreen",s)&&s.fullscreen){e.key_exists("icon",s)&&s.icon?o="<i class='"+s.icon+"'></i>":o="<span>"+s.title+"</span>";u.append("<div title='"+s.title+"' class='nc-widget nc--"+i[a].color+"'><div><a href='"+s.fullscreen+"' onclick='return nc.ui.dashboard.fullscreen(this)'>"+o+"</a></div></div>")}}};n.reset_user_widgets=function(n){t(n).addClass("nc--disabled");t.ajax({type:"POST",url:e.config("admin_path")+"dashboard/ajax.php?action=reset_user_widgets",dataType:"json",success:function(){window.location.reload()}});return!1};n.fullscreen=function(r,i){n.close_fullscreen(!0);var s=t("#nc-dashboard-full"),o=t("iframe",s),u=t(r);t("#nc-dashboard").hide();s.show();i=i||u.attr("href");e.process_start("dashboard_full");o.hide();o[0].contentWindow.$nc("#mainViewIframe").attr("src",i).load(function(){e.process_stop("dashboard_full");o.fadeIn();this.contentWindow.document.getElementsByTagName("body")[0].style.paddingRight="20px";o[0].contentWindow.nc(o[0].contentWindow).resize()});return!1};n.close_fullscreen=function(e){e=e||!1;var n=t("#nc-dashboard-full"),r=t("iframe",n)[0].contentWindow;n.hide();r.nc("#mainViewIframe").attr("src","about:blank");e||t("#nc-dashboard").show()};n.append_controls=function(i,s){var o=n.opt.grid_margin,u=n.opt.grid_size,a=u+o*2,f=0,l=t("<div/>",{"class":"nc-widget-actions"});s.fullscreen&&l.append(t("<i/>",{"class":"nc-icon nc--widget-maximize nc--hovered"}).click(function(){n.fullscreen(this,s.fullscreen);return!1}));l.append(t("<i/>",{"class":"nc-icon nc--widget-edit"}).click(function(){n.widget_dialog(i,s);return!1}));l.append(t("<i/>",{"class":"nc-icon nc--widget-close"}).click(function(){n.close_widget(i);delete n.user_widgets[s.type];return!1}));t("<div/>",{"class":"nc-widget-overlay"}).appendTo(i);l.appendTo(i);if(s.resizeble){t(i).resizable({grid:[a,a],animate:!1,minWidth:u,minHeight:u,maxWidth:a*5,maxHeight:a*3,autoHide:!0,start:function(){f=r.$el.height()},resize:function(e){if(e.offsetY>r.$el.height()){var t=Math.ceil((e.offsetY-f)/a+1),n=f+t*a;r.$el.css("height",n)}},stop:function(){var i=t(this);setTimeout(function(){var t=Math.ceil((i.width()-u)/a+1),n=Math.ceil((i.height()-u)/a+1);r.resize_widget(i,t,n);r.set_dom_grid_height();e.event.call(["dashboard","resize"])},150);n.resize_content(i)}});t("div.ui-resizable-handle",i).hover(function(){r.disable()},function(){r.enable()})}};n.resize_content=function(e){e.find("div.nc-widget>div:first-child").css({width:e.width(),height:e.height(),padding:0,margin:0});t(window).trigger("resize")};n.edit_mode=function(i){n.close_fullscreen();var s=t("#nc-dashboard").toggleClass("nc-edit-mode").hasClass("nc-edit-mode");i&&t(i).css({"border-color":s?"#56be2a":""});if(s){r.enable();e.root("#mainViewButtons div.nc_dashboard_reset_widgets").removeClass("nc--disabled").show()}else{r.disable();e.root("#mainViewButtons div.nc_dashboard_reset_widgets").hide()}return!1};n.close_widget=function(t){t.animate({opacity:0},function(){setTimeout(function(){r.remove_widget(t);e.event.call(["dashboard","close"])},300)})};n.register_widget=function(t,s,o){o!==!1&&(o=!0);if(!e.key_exists(t.type,n.widget_types))return!1;n.user_widgets[t.type]=t;var u=n.widget_types[t.type],a={type:t.type,row:i(t,u,"row",1),col:i(t,u,"col",1),size:i(t,u,"size",t.size),color:i(t,u,"color","lighten"),query:i(t,u,"query","route=index"),fullscreen:i(t,u,"fullscreen",!1),resizeble:i(t,u,"resizeble",!1)},f=r.serialize(s);f[0].el.widget_settings=a;n.resize_content(s);e.ui.custom_scroll(s.find("div.nc-widget-scrolled"));s.find(">div").show();n.append_controls(s,a);o&&e.event.call(["dashboard","register"])};n.add_widget=function(s,o,u){u!==!1&&(u=!0);if(!e.key_exists(s.type,n.widget_types))return!1;n.user_widgets[s.type]=s;var a=n.widget_types[s.type],f={type:s.type,row:i(s,a,"row",1),col:i(s,a,"col",1),size:i(s,a,"size",s.size),color:i(s,a,"color","lighten"),query:o||i(s,a,"query","route=index"),fullscreen:i(s,a,"fullscreen",!1),resizeble:i(s,a,"resizeble",!1)};e.process_start("dashboard.add_widget():"+s.type);var l=t("<div class='nc-widget-box'></div>"),c=r.add_widget(l.html("<div class='nc-widget nc--loader'></div>"),f.size[0],f.size[1],f.col,f.row);c.widget_settings=f;t.get(a.controller+"?"+f.query,function(t){l.html("<div class='nc-widget nc--"+f.color+"' style='display:none'>"+t+"</div>");n.resize_content(l);e.ui.custom_scroll(l.find("div.nc-widget-scrolled"));l.find(">div").fadeIn(250);e.process_stop("dashboard.add_widget():"+s.type);n.append_controls(l,f);n.user_widgets.push(r.serialize(l));u&&e.event.call(["dashboard","add"])})};n.close_widget_dialog=function(){if(n._edited_widget){var t=n._edited_widget,r=n.widget_types[t.type];n.select_widget_color(i(t,r,"color",null))}e.root.$.modal.close()};n.widget_dialog=function(s,o){s=s||null;o=o||null;if(!s&&e.root("#mainViewButtons div.nc_dashboard_add_widget").hasClass("nc--disabled"))return!1;var u=e.root.$,a=u("#nc_widget_dialog");if(!a.length){u("body").append(t("#nc_widget_dialog"));a=u("#nc_widget_dialog")}var f=a.find("button[type=submit]"),l=a.find("select[name=widget_type]"),c=a.find("input[name=widget_color]"),h=a.find("#nc_widget_settings");l.html("");for(var p in n.widget_types){var d=e.is_undefined(n.user_widgets[p])?"":" disabled='disabled'";l.append("<option value='"+p+"'"+d+">"+n.widget_types[p].title+"</option>")}o&&l.val(o.type);n._edited_widget_obj=s;n._edited_widget=o;a.modal({closeHTML:"",containerId:"nc_small_modal_container",onShow:function(p){var d=p.container;d.find("div.simplemodal-wrap").css({padding:0,overflow:"inherit"});f.click(function(){n.close_fullscreen();var e=h.find("form").serialize();u.modal.close();var t=l.val(),i=c.val();if(o){t&&(o.type=t);i&&(o.color=i);r.remove_widget(s,function(){n.add_widget(o,e)})}else n.add_widget({type:t,color:i},e);return!1});l.change(function(){var r=n.widget_types[this.value];h.html("").hide();d.css({width:a.width(),height:a.height()});u(parent?parent.window:window).resize();n.select_widget_color(i(o,r,"color",null));e.key_exists("settings",r)&&r.settings&&t.get(r.controller+"?route=settings",function(e){if(e){h.html(e).show();if(o&&o.query){var i=n.unserialize(o.query);h.find("input,select").each(function(){this.name&&r(this.name,i)&&t(this).val(i[this.name])})}}d.css({width:a.width(),height:a.height()});u(parent?parent.window:window).resize()})}).trigger("change");d.addClass("nc-shadow-large").css({width:a.width(),height:a.height()});u(parent?parent.window:window).resize()}});return!1};n.select_widget_color=function(t){t=t||"lighten";var r=e.root.$,i=r("#nc_widget_color_palette");i.find("a.nc--selected").removeClass("nc--selected");i.find("input[name=widget_color]").val(t);i.find("span.nc--"+t).parent().addClass("nc--selected");n._edited_widget_obj&&n._edited_widget_obj.find(".nc-widget").attr("class","nc-widget nc--"+t);return!1};n.unserialize=function(e){e=decodeURI(e);var t=e.split("&"),n={},r,i;for(var s=0,o=t.length;s<o;s++){r=t[s].split("=");i=r[0];if(i.indexOf("[]")===i.length-2){var u=i.substring(0,i.length-2);n[u]===undefined&&(n[u]=[]);n[u].push(r[1])}else n[i]=r[1]}return n};e.ui.ext("dashboard",n)})(nc,nc.$);